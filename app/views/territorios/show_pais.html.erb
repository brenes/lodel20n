<%= raw @territorio.decorator(:Html).sidebar %>
<div id="sidebar">
  <h3><%=@territorio.nombre%></h3>
  <div>
    <ul>
      <li><%= number_with_delimiter Territorio.comunidad.count %> Comunidades </li>
      <li><%= number_with_delimiter Territorio.provincia.count %> Provincias </li>
      <li><%= number_with_delimiter Territorio.municipio.count %> Municipios </li>
      <li><%= number_with_delimiter @territorio.ultimo_escrutinio.total_nulos %> Votos nulos</li>
      <li><%= number_with_delimiter @territorio.ultimo_escrutinio.total_abstenciones %> Abstenciones</li>
      <li><%= number_with_delimiter @territorio.ultimo_escrutinio.total_contabilizados %> Votos útiles</li>
      <li><%= number_with_delimiter @territorio.ultimo_escrutinio.total_votos, :locale => :es %> Votos</li>
      
    </ul>
  </div>
</div>

<div id="inner_content">
  
  <table class="datos-principales">
    <thead>
      <tr>
        <th>Partido</th>
        <th>Votos totales</th>
        <th>% Votos</th>
        <th>Escaños</th>
        <th>Aumento de votos</th>
        <th>Aumento de escaños</th>
      </tr>
    </thead>
    <tbody>
    <% ultimo_resultado = nil %>
      <% @territorio.ultimo_escrutinio.resultados.all(:order => "total_votos ASC"). each do |resultado| %>
      <tr>
        <td>
          <%= resultado.partido.nombre %>
        </td>
        <td>
          <%= number_with_delimiter resultado.total_votos %>
        </td>
        <td>
          <%= resultado.pct_votos %>
        </td>
        <td>
          <%= resultado.escanos %>
        </td>
        <td>
          <%= ultimo_resultado.nil? ? "--" : number_to_percentage(100-(100*ultimo_resultado.total_votos/resultado.total_votos.to_f), :precision => 4) %>
        </td>
        <td>
          <%= (ultimo_resultado.nil? || resultado.escanos== 0) ? "--" : number_to_percentage(100-(100*ultimo_resultado.escanos/resultado.escanos.to_f), :precision => 4) %>
        </td>
        <% ultimo_resultado = resultado %>
      </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div id="graphic"></div>

<script type="text/javascript" src="https://github.com/mbostock/d3/raw/v1.8.2/d3.js"></script>

<script type="text/javascript">
<% @territorio.escrutinios.each do |escrutinio| %>
  var data = <%= raw escrutinio.resultados.map{|r| {:name => r.partido.nombre, :pct => r.pct_votos}}.to_json%>;

  var c = d3.scale.linear().domain([0,100]).range(["rgb(50%, 0, 0)", "rgb(100%, 0, 0)"]).interpolate(d3.interpolateRgb)
  var pct_acumulado = 100
  var vis = d3.select("#graphic")
      .append("div")
      .attr("width", "100%")

  vis.append("span")
      .text("<%= escrutinio.hora %>: <%= escrutinio.pct_escrutado %>%")

  vis.selectAll("div")
      .data(data)
      .enter().append("div")
      .style("width", function(d) { return d.pct+'%' })
      .style("clear", function(d, i) { return (i == 0) ? "left" : "none" })
      .style("background-color", function(d) { pct_acumulado -= d.pct; return  c(pct_acumulado + d.pct) })
      .text(function(d) { return d.name + '(' + d.pct+'%)'});
<% end %>
</script>

<div>
  <h2>Comunidades</h2>

  <ul>
  <% @territorio.hijos.each do |hijo| %>
    <li><%= link_to hijo.nombre, territorio_path(hijo) %> </li>
  <% end %>
  </ul>
</div>
